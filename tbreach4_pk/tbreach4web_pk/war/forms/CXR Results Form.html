<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Chest X-Ray Test Results (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Test Results Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser"/>
				</td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Test Results">
		<div>
		<p>
			<lookup expression="fn.getConcept('75').description"/><br/>
			<obs conceptId="75" id="barcode" defaultValue=""/>
		</p>
		<p>
			<lookup expression="fn.getConcept('76').description"/><br/>
			<obs conceptId="76" id="cad4tb_result"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('77').description"/><br/>
			<obs conceptId="77" id="xray_result" answerConceptIds="30,31" defaultValue="30" style="radio"/>
		</p>
		<p style="color: blue;">
			Note: CAD4TB > 49 indicates Abnormality
		</p>
		</div>
	</section>
	<submit/>
	
	<script type="text/javascript">
	if(jQuery) {
		$j(document).ready(function() {
			$j("#cad4tb_result").change(function() {
				var cad4TbValue = getValue("cad4tb_result.value");
				var xrayResultRadios = $j("input[name=w12]");
				// If cat4TbValue is less than 50, then check Normal, otherwise check Abnormal
				if (cad4TbValue >= 50) {
					xrayResultRadios[1].checked = true;
				}
				else {
					xrayResultRadios[0].checked = true;
				}
			});
		});
	}
	function luhnCheckDigit(number) {
		var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
		number = number.toUpperCase().trim();
		var sum = 0;
		for (var i = 0; i &lt; number.length; i++) 
		{
			var ch = number.charAt(number.length - i - 1);
			if (validChars.indexOf(ch) &lt; 0) {
				return -1;
			}
			var digit = ch.charCodeAt(0) - 48;
			var weight;
			if (i % 2 == 0) {
				weight = (2 * digit) - parseInt(digit / 5) * 9;
			}
			else {
				weight = digit;
			}
			sum += weight;
		}
		sum = Math.abs(sum) + 10;
		var digit = (10 - (sum % 10)) % 10;
		return digit;
	}
	<!-- Error Checking before Form Submit -->
	beforeSubmit.push(function() {
		// Validate barcode
		var valid = true;
		var error = '';
		var barcode = getValue('barcode.value');
		var pattern = new RegExp("^\\d{1,13}-\\d$");
		valid = pattern.test(barcode);
		if (!valid || barcode.length != 12) {
			error = "Barcode is invalid or empty. Please check that you have entered correct barcode.\n";
		}
		else {
			// Check Luhn digit for barcode
			var number = barcode.substring(0, barcode.length - 2);
			var digit = barcode.charAt(barcode.length - 1);
			var luhnDigit = luhnCheckDigit(number);
			if (digit != luhnDigit) {
				valid = false;
		    	error = "Barcode is invalid or does not exist. Please check that you have entered correct barcode.\n";			
			}
		}
		if (!valid) {
			alert (error);
		}
		// If the X-Ray is abnormal, ask the user to fill a Test Indication form for GXP
		else {
			var xrayResult = getValue('xray_result');
			if (xrayResult == 31) {
				alert("The X-Ray is Abnormal. Please fill a 'Test Indication' form for Gene Xpert for this client.");
			}
		}
        return valid;
	});
	</script>
</htmlform>