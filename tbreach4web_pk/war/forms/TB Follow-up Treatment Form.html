<!-- Copyright(C) 2015 Interactive Health Solutions, Pvt. Ltd.

This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as
published by the Free Software Foundation; either version 3 of the License (GPLv3), or any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Interactive Health Solutions, info@ihsinformatics.com
You can also access the license on the internet at the address: http://www.gnu.org/licenses/gpl-3.0.html

Interactive Health Solutions, hereby disclaims all copyright interest in this program written by the contributors.

Contributors: Tahira Niazi -->
<htmlform>
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>TB Follow-up Treatment Form (v1.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
				<tr>
					<td>Form Date:</td>
					<td><encounterDate default="today"/></td>
				</tr>
				<tr>
					<td>Location:</td>
					<td><encounterLocation default="1"/></td>
				</tr>
				<tr>
					<td>Provider (Auto):</td>
					<td><encounterProvider default="currentUser" type="autocomplete"/></td>
				</tr>
		</table>
	</section>
	<section headerLabel="2. Patient Information">
		<div>
			<p>
				Patient Identifier:
                                <lookup class="value" expression="patient.getPatientIdentifier(1)"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('22').description"/><br/>
				<obs conceptId="22" id="weight"/>
			</p>
		</div>
	</section>

          <section headerLabel="3. Treatment Follow-up">
		<div>
                        <p>
                              Date of Treatment Initiation:
                           <b>   <span id="date-value">  <lookup complexExpression="#if ($fn.latestObs(173)) $fn.latestObs(173).getDateCreated() #else #end"/>  </span> </b>
                       </p>
			<p>
				<lookup expression="fn.getConcept('283').description"/>:
                                <b><span id="month-value"></span></b>
			</p>
			<p>
				<lookup expression="fn.getConcept('290').description"/>:
			        <b><lookup expression="fn.latestObs(290).valueCoded.name"/></b>
			</p>
                         <p>
				<lookup expression="fn.getConcept('297').description"/>:
			         <b><lookup expression="fn.latestObs(297).valueCoded.name"/></b>
			</p>
                         <p>
				<lookup expression="fn.getConcept('301').description"/><br/>
				<b><lookup expression="fn.latestObs(301).valueCoded.name"/></b>
			</p>
                         <p>
				<lookup expression="fn.getConcept('319').description"/><br/>
				<b><lookup expression="fn.latestObs(319).valueCoded.name"/></b>
			</p>
		</div>
	</section>

        <section headerLabel="4. Follow-up History">

                  <div>

                 <div id="female_div">
				<p>
					Has the Patient/Suspect's pregnancy status changed?<br/>
					<obs conceptId="286" id="pregnant" defaultValue="2"/>
				</p>
				<p>
					Has the Patient/Suspect's breastfeeding status changed?<br/>
					<obs conceptId="287" id="breastfeeding" defaultValue="2"/>
				</p>
			</div>

			<p>
				<lookup expression="fn.getConcept('329').description"/><br/>
				<obs conceptId="329" id="nausea_abdominal_pain" answerConceptIds="1,2" defaultValue="2"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('331').description"/><br/>
				<obs conceptId="331" id="joint_pain" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('333').description"/><br/>
				<obs conceptId="333" id="skin_burning" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('336').description"/><br/>
				<obs conceptId="336" id="skin_rash" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('337').description"/><br/>
				<obs conceptId="337" id="visual_loss" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('338').description"/><br/>
				<obs conceptId="338" id="hearing_loss" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('339').description"/><br/>
				<obs conceptId="339" id="diziness" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('340').description"/><br/>
				<obs conceptId="340" id="jaundice" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('334').description"/><br/>
				<obs conceptId="334" id="other_side_effect" size="50"/>
			</p>
		</div>
	</section>

       <section headerLabel="5. Follow-up Sputum Results">
		<div>
                         <p>
                               Previous Smear Microscopy Result(s), if any:<br/>
                               <div id="smear1_div"> <b><span id="smear-result"></span></b><br/> </div>
                               <div id="smear2_div"> <b><span id="smear-result1"></span></b><br/> </div>
                               <div id="smear3_div"> <b><span id="smear-result2"></span></b><br/> </div>
                               <div id="smear4_div"> <b><span id="smear-result3"></span></b><br/> </div>
                               <div id="smear5_div"> <b><span id="smear-result4"></span></b><br/> </div>
                               <div id="smear6_div"> <b><span id="smear-result5"></span></b><br/> </div>
                               <div id="smear7_div"> <b><span id="smear-result6"></span></b><br/> </div>
                               <div id="smear8_div"> <b><span id="smear-result7"></span></b><br/> </div>
                             
                          </p>
                               
                          <p>
                                 <lookup expression="fn.getConcept('283').description"/>:
                                 <obs conceptId="283" id="month"/>
                          </p>
                         <p>
				Smear Microscopy Results<br/>
				<obs conceptId="473" id="sputum_result" defaultValue="208"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('114').description"/>:
				<b><lookup expression="fn.latestObs(114).valueCoded.name"/></b>
			</p>
			<p>
				<lookup expression="fn.getConcept('115').description"/>:
				<b><lookup expression="fn.latestObs(115).valueCoded.name"/></b>
			</p>
		</div>
	</section>

       <section headerLabel="6. New Regimen">
		<table class="baseline-aligned">
		<div>
			<p>
				<lookup expression="fn.getConcept('451').description"/><br/>
				<obs conceptId="451" id="side_effect_alert" answerConceptIds="1,2" defaultValue="2"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('452').description"/><br/>
				<obs conceptId="452" id="change_regimen" answerConceptIds="1,2" defaultValue="2"/>
			</p>
			 <p>
				<lookup expression="fn.getConcept('453').description"/><br/>
				<obs conceptId="453" id="patient_refferal" answerConceptIds="1,2" defaultValue="2"/>
			</p>
                         <p>
				<lookup expression="fn.getConcept('301').description"/><br/>
				<obs conceptId="301" id="treatment_plan" answerConceptIds="299,300" defaultValue="299"/> 
			</p>
				<p>
					<lookup expression="fn.getConcept('319').description"/><br/>
				<obs conceptId="319" id="drug_serial" answerConceptIds="302,303,304,305,306,307,308,309,310,311,312,3" defaultValue="302"/>
				</p>
                          <p>
                               <lookup expression="fn.getConcept('472').description"/><br/>
                               <obs conceptId="472" id="current_status" defaultValue="464"/>
                        </p>
                        <p>
                               <lookup expression="fn.getConcept('398').description"/><br/>
                                 <obs conceptId="398" id="next_drug_dispersal_date" allowFutureDates="true"/>
                        </p>
		</div>
		</table>
	</section>
	
	<submit/>

	<script type="text/javascript">
		if(jQuery) {
		$j(document).ready(function() {

                         //Hiding SmearResults Fields:
                         var smear1Div = $j("#smear1_div"); smear1Div.hide();
                         var smear2Div = $j("#smear2_div"); smear2Div.hide();
                         var smear3Div = $j("#smear3_div"); smear3Div.hide();
                         var smear4Div = $j("#smear4_div"); smear4Div.hide();
                         var smear5Div = $j("#smear5_div"); smear5Div.hide();
                         var smear6Div = $j("#smear6_div"); smear6Div.hide();
                         var smear7Div = $j("#smear7_div"); smear7Div.hide();
                         var smear8Div = $j("#smear8_div"); smear8Div.hide();
                      
                        // Get previous smear results if any
                        var smearResults = "<lookup complexExpression="#foreach($id in $fn.allObs(473)) $id.valueCoded.name #end"/>";
                        
                        // No previous smear results
                        if (smearResults == null || smearResults == ""){
                            $j('#smear-result').html("N/A");
                            smear1Div.show();
                          }
                       else{ // previous result available
                            // Get months for previous result
                           var smearResultsMonth = "<lookup complexExpression="#foreach($id in $fn.allObs(283)) $id.valueNumeric #end"/>";  
                           var n = smearResults.search("  ");
                           if (n == -1){ // if only one result
                                var m = getMonth(smearResultsMonth);
                                var resultString = m.concat(smearResults);
                                $j('#smear-result').html(resultString);
                                smear1Div.show();
                           }
                           else{  // more than one result
                                var resultArray = smearResults.split("  ");
                                var monthArray = smearResultsMonth.split("  ");
                                var resultArrayLength = resultArray.length;
                                var monthArrayLength = monthArray.length;
                                if(resultArrayLength == monthArrayLength){
                                
                                    for (var i = resultArrayLength-1; 0 &lt;= i; i--) 
		                        {
                                          
                                           var resultString = "";
                                           var m = getMonth(monthArray[i]);
                                           resultString = resultString.concat(m);
			                   resultString = resultString.concat(resultArray[i]);
                                           if(monthArray[i] == 1.0) { $j('#smear-result').html(resultString); smear1Div.show(); }
                                           if(monthArray[i] == 2.0) { $j('#smear-result1').html(resultString); smear2Div.show(); }
                                           if(monthArray[i] == 3.0) { $j('#smear-result2').html(resultString); smear3Div.show(); }                                      
                                           if(monthArray[i] == 4.0) { $j('#smear-result3').html(resultString); smear4Div.show(); }
                                           if(monthArray[i] == 5.0) { $j('#smear-result4').html(resultString); smear5Div.show(); }
                                           if(monthArray[i] == 6.0) { $j('#smear-result5').html(resultString); smear6Div.show(); }
                                           if(monthArray[i] == 7.0) { $j('#smear-result6').html(resultString); smear7Div.show(); }
                                           if(monthArray[i] == 8.0) { $j('#smear-result7').html(resultString); smear8Div.show(); }
                                         	                         
                                        } //for ends
                                 }  // if ends!
                                else {
                                    alert("Error!!!");    
                                }

                           } //else ends

                        }  //else ends!                     

                        // get Month of treatment from date of treatment initiation 
                        var valueDate = document.getElementById('date-value').innerText;
                        var months = diffMonth(valueDate);
                        $j('#month-value').html(months);
  
                        // If gender is male, then hide Pregnancy and Breastfeeding questions
			var gender = "<lookup expression="patient.gender"/>";
			var femaleDiv = $j("#female_div");
			if (gender == "M") {
				femaleDiv.hide();
			}
    
		});
	}

                function diffMonth(initialDate) {
		           
                         var a = new Date(initialDate);
                         var b = new Date();
 
                           // Months between years.
                         var months = (b.getFullYear() - a.getFullYear()) * 12;

                           // Months between... months.
                         months += b.getMonth() - a.getMonth();
                         
                         return months;
	}

                 function getMonth(month) {
		           
                        if(month == 1.0) return "Baseline Smear Microscopy Result: ";
                        else  if(month == 2.0) return "Month 2 Smear Microscopy Result: ";
                        else  if(month == 3.0) return "Month 3 Smear Microscopy Result: ";
                        else  if(month == 4.0) return "Month 4 Smear Microscopy Result: ";
                        else  if(month == 5.0) return "Month 5 Smear Microscopy Result: ";
                        else  if(month == 6.0) return "Month 6 Smear Microscopy Result: ";
                        else  if(month == 7.0) return "Month 7 Smear Microscopy Result: ";
                        else  if(month == 8.0) return "Month 8 Smear Microscopy Result: "; 
                        else return "error";                           
	}

              <!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
                          var valid = true;
		          var val = getValue('weight.value');
                           if (val == null || val == '') {
                                getField('weight.error').html('Current weight required').show();
                                valid = false;
                           }
                           var val = getValue('month.value');
                            if (val == null || val == '') {
                                getField('month.error').html('Month of sputum result required').show();
                                valid = false;
                           }
                           else{
                           var valueMonth = document.getElementById('month-value').innerText;
                           var mon = parseInt(valueMonth);  
                           if(!(val &lt;= mon)){
                                getField('month.error').html('Enter valid treatment month').show();
                                 valid = false;
                             }
                           }
                   return valid;
		});
	</script>
</htmlform>
