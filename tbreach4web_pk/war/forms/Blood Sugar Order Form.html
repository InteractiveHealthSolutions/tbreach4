<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Blood Sugar Test Order (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Test Order Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser"/>
				</td>
			</tr>
		</table>
	</section>
	<section headerLabel="2. Blood Sugar Test Order Information">
		<div>
		<p>
			<lookup expression="fn.getConcept('118').description"/><br/>
			<obs conceptId="118" id="taking_medication" answerConceptIds="1,2,3,4" defaultValue="2"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('119').description"/><br/>
			<obs conceptId="119" id="medicine_name" size="20"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('26').description"/><br/>
			<obs conceptId="26" id="family_medication" answerConceptIds="1,2,3,4" defaultValue="2"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('120').description"/><br/>
			<obs conceptId="120" id="physical_activity" answerConceptIds="1,2,3,4" defaultValue="2"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('132').description"/><br/>
			<obs conceptId="132" id="eat_vegitables" answerConceptIds="122,131,4" defaultValue="122"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('135').description"/><br/>
			<obs conceptId="135" id="last_food" answerConceptIds="134,136,3,4" defaultValue="134"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('137').description"/><br/>
			<obs conceptId="137" id="paid_for_test" style="radio" answerConceptIds="1,2" defaultValue="1"/>
		</p>
		<p>
			<lookup expression="fn.getConcept('138').description"/><br/>
			<obs conceptId="138" id="barcode" size="13"/>
		</p>
		</div>
	</section>
	<submit/>

	<script type="text/javascript">
		if(jQuery) {
			$j(document).ready(function() {
				var hasDiabetes = "<lookup complexExpression="$fn.latestObs(24).valueCoded"/>";
				var diabetesMedicineDiv = $j("#diabetes_medicine_div");
				if (hasDiabetes == 1) {
					diabetesMedicineDiv.show();
				}
				else {
					diabetesMedicineDiv.hide();
				}
			});
		}
		function luhnCheckDigit(number) {
			var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
			number = number.toUpperCase().trim();
			var sum = 0;
			for (var i = 0; i &lt; number.length; i++) 
			{
				var ch = number.charAt(number.length - i - 1);
				if (validChars.indexOf(ch) &lt; 0) {
					return -1;
				}
				var digit = ch.charCodeAt(0) - 48;
				var weight;
				if (i % 2 == 0) {
					weight = (2 * digit) - parseInt(digit / 5) * 9;
				}
				else {
					weight = digit;
				}
				sum += weight;
			}
			sum = Math.abs(sum) + 10;
			var digit = (10 - (sum % 10)) % 10;
			return digit;
		}
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			// Validate lab test code
			var valid = true;
			var error = '';
			var barcode = getValue('barcode.value');
			var pattern = new RegExp("^\\d{1,10}-\\d$");
			valid = pattern.test(barcode);
			if (!valid || barcode.length != 12) {
				error = "Lab Test Code is invalid or empty. Please check that you have entered correct lab test code.\n";
			}
			else {
				// Check Luhn digit for lab test code
				var number = barcode.substring(0, barcode.length - 2);
				var digit = barcode.charAt(barcode.length - 1);
				var luhnDigit = luhnCheckDigit(number);
				if (digit != luhnDigit) {
					valid = false;
			    	error = "Lab Test Code is invalid or does not exist. Please check that you have entered correct lab test code.\n";			
				}
			}
			// Check if the same Lab Test Code exists
			var codes = "<lookup complexExpression="#foreach($id in $fn.allObs(138)) $id.valueText #end"/>";
			var str = JSON.stringify(codes)
			if (str.indexOf(barcode) != -1) {
				error = "Lab Test Code has already been used. Please use a new Code.";
				valid = false;
			}
			if (!valid) {
				alert (error);
			}
	        return valid;
		});
	</script>
</htmlform>
