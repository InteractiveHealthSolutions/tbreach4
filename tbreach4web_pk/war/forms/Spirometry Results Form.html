<!-- Copyright(C) 2015 Interactive Health Solutions, Pvt. Ltd.

This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as
published by the Free Software Foundation; either version 3 of the License (GPLv3), or any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Interactive Health Solutions, info@ihsinformatics.com
You can also access the license on the internet at the address: http://www.gnu.org/licenses/gpl-3.0.html

Interactive Health Solutions, hereby disclaims all copyright interest in this program written by the contributors.

Contributors: Tahira Niazi -->
<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Spiromentry Test Results (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Test Results Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser"/>
				</td>
			</tr>
		</table>
	</section>
	<section headerLabel="3. Spiromentry Test Result">
		<div>
			<p>
				<lookup expression="fn.getConcept('149').description"/><br/>
				<obs conceptId="149" id="barcode" size="13"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('150').description"/><br/>
				<obs conceptId="150" id="fvc_result"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('151').description"/><br/>
				<obs conceptId="151" id="fev1_result"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('152').description"/><br/>
				<obs conceptId="152" id="fvc_fev1_ratio"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('153').description"/><br/>
				<obs conceptId="153" id="copd_patient" answerConceptIds="1,2" defaultValue="2" style="radio"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('154').description"/><br/>
				<obs conceptId="154" id="fev1_predicted_result"/>
			</p>
<div id="copd_stage_div">
			<p>
				<lookup expression="fn.getConcept('155').description"/><br/>
				<obs conceptId="155" id="copd_stage" answerConceptIds="54,55,52,53" style="radio" defaultValue="54"/>
			</p>
</div>
		</div>
	</section>
	<submit/>
	
	<script type="text/javascript">
		if(jQuery) {
			$j(document).ready(function() {
			auto-populate & disable functionality commented.
			/*	$j("#fvc_fev1_ratio").find("input").attr("disabled", true);
				$j("#copd_patient").find("input").attr("disabled", true);
				$j("#copd_stage").find("input").attr("disabled", true);
				$j("#fvc_result").change(function() {
					autoPopulateResults();
				});
				$j("#fev1_result").change(function() {
					autoPopulateResults();
				}); 
                                // New Regimen required then show else hide 
			$j("#copd_patient").change(function() {
				var copdStageDiv = $j("#copd_stage_div");
				var copdPatientValue = getValue('copd_patient.value');
				if (copdPatientValue == 1) {
					copdStageDiv.show();
				}
				else {
					copdStageDiv.hide();
				}
			});
			$j("#copd_patient").change();*/
			});
		}
		// Set values for auto-populated fields
		
		
	/*	function autoPopulateResults() {
			var fvcValue = getValue("fvc_result.value");
			var fev1Value = getValue("fev1_result.value");
			if (fvcValue == "" || fev1Value == "") {
				return;
			}
			var ratio = Math.round(fvcValue / fev1Value * 100);
			setValue("fvc_fev1_ratio.value", ratio);
			// w16 is the name of copd_patient radio group on HTML page
			var fvcFev1Radios = $j("input[name=w16]");
			// If ratio is less than 70, then check "Yes", otherwise check "No" 
			if (ratio &lt; 70) {
				fvcFev1Radios[0].checked = true;
			}
			else {
				fvcFev1Radios[1].checked = true;
			}
			// w20 is the name of copd_stage radio group on HTML page
			var copdStageRadios = $j("input[name=w20]");
			// If ratio >= 80 then check "Mild"; if 50-79, then "Moderate"; if 30-49, then "Sever", otherwise "Very Severe"
			if (ratio >= 80) {
				copdStageRadios[0].checked = true;
			}
			else if (ratio >= 50) {
				copdStageRadios[1].checked = true;
			}
			else if (ratio >= 30) {
				copdStageRadios[2].checked = true;
			}
			else {
				copdStageRadios[3].checked = true;
			}
		} */
		function luhnCheckDigit(number) {
			var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
			number = number.toUpperCase().trim();
			var sum = 0;
			for (var i = 0; i &lt; number.length; i++) 
			{
				var ch = number.charAt(number.length - i - 1);
				if (validChars.indexOf(ch) &lt; 0) {
					return -1;
				}
				var digit = ch.charCodeAt(0) - 48;
				var weight;
				if (i % 2 == 0) {
					weight = (2 * digit) - parseInt(digit / 5) * 9;
				}
				else {
					weight = digit;
				}
				sum += weight;
			}
			sum = Math.abs(sum) + 10;
			var digit = (10 - (sum % 10)) % 10;
			return digit;
		}
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			// Validate barcode
			var valid = true;
			var error = '';
			var barcode = getValue('barcode.value');
			var pattern = new RegExp("^\\d{1,10}-\\d$");
			valid = pattern.test(barcode);
			if (!valid || barcode.length > 12) {
				error = "Lab test code is invalid or empty. Please check that you have entered correct lab test code.\n";
			}
			else {
				// Check Luhn digit for barcode
				var number = barcode.substring(0, barcode.length - 2);
				var digit = barcode.charAt(barcode.length - 1);
				var luhnDigit = luhnCheckDigit(number);
				if (digit != luhnDigit) {
					valid = false;
			    	error = "Lab test code is invalid or does not exist. Please check that you have entered correct lab test code.\n";			
				}
			}
			if (!valid) {
				alert (error);
			}
	        return valid;
		});
	</script>
</htmlform>
