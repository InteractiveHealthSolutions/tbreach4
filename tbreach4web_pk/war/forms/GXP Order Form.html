<!-- Copyright(C) 2015 Interactive Health Solutions, Pvt. Ltd.

This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as
published by the Free Software Foundation; either version 3 of the License (GPLv3), or any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with this program; if not, write to the Interactive Health Solutions, info@ihsinformatics.com
You can also access the license on the internet at the address: http://www.gnu.org/licenses/gpl-3.0.html

Interactive Health Solutions, hereby disclaims all copyright interest in this program written by the contributors.

Contributors: Tahira Niazi -->
<htmlform>
	<br/>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>
	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
			cellspacing: 5px
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Gene Xpert Test Order (v1.0)</h2>
	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Test Order Date:</td>
				<td>
					<encounterDate default="today"/>
				</td>
			</tr>
			<tr>
				<td>Location:</td>
				<td>
					<encounterLocation default="1"/>
				</td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td>
					<encounterProvider default="currentUser"/>
				</td>
			</tr>
		</table>
	</section>
	<section headerLabel="2. Gene Xpert Test Order Information">
		<!-- Referrer -->
		<div id="referral_div">
			<p>
				<lookup expression="fn.getConcept('207').description"/><br/>
				<obs conceptId="207" id="referrer" answerConceptIds="85,86,87,88,89,90,3,4" defaultValue="85"/>
			</p>
			<div id="relationship_div">
				<p>
					<lookup expression="fn.getConcept('103').description"/><br/>
					<obs conceptId="103" id="referrer_relationship"/>
				</p>
			</div>
			<p>
				<lookup expression="fn.getConcept('104').description"/><br/>
				<obs conceptId="104" id="patient_care" answerConceptIds="1,2,3,4" defaultValue="1" style="radio"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('105').description"/><br/>
				<obs conceptId="105" id="tb_household" answerConceptIds="1,2,3,4" defaultValue="1" style="radio"/>
			</p>
			<p>
				<lookup expression="fn.getConcept('106').description"/><br/>
				<obs conceptId="106" id="tb_roommate" answerConceptIds="1,2,3,4" defaultValue="2" style="radio"/>
			</p>
		</div>
		<hr></hr>

		<!-- TB Medication -->
		<div>
			<p>
				<lookup expression="fn.getConcept('107').description"/><br/>
				<obs conceptId="107" id="past_tb_medication" answerConceptIds="1,2,3,4" defaultValue="2" style="radio"/>
			</p>
			<div id="current_tb_medication_div">
				<p>
					<lookup expression="fn.getConcept('108').description"/><br/>
					<obs conceptId="108" id="current_tb_medication" answerConceptIds="1,2,3,4" defaultValue="2" style="radio"/>
				</p>
			</div>
			<div id="streptomycin_div">
				<p>
					<lookup expression="fn.getConcept('109').description"/><br/>
					<obs conceptId="109" id="streptomycin" answerConceptIds="1,2,3,4" defaultValue="2" style="radio"/>
				</p>
			</div>
			<hr></hr>
		</div>

		<!-- Sputum Sample -->
		<div>
			<p>
				<lookup expression="fn.getConcept('162').description"/><br/>
				<obs conceptId="162" id="specimen_type" answerConceptIds="160,161" defaultValue="160" style="radio"/>
			</p>
			<div id="sputum_quality_div">
				<p>
					<lookup expression="fn.getConcept('111').description"/><br/>
					<obs conceptId="111" id="sputum_quality" answerConceptIds="36,37,38,3" defaultValue="36" style="radio"/>
				</p>
			</div>
			<div id="bloody_sputum_div">
				<p>
					<lookup expression="fn.getConcept('159').description"/><br/>
					<obs conceptId="159" id="bloody_sputum" answerConceptIds="1,2" defaultValue="2" style="radio"/>
				</p>
			</div>
			<div id="sputum_volume_div">
				<p>
					<lookup expression="fn.getConcept('262').description"/><br/>
					<obs conceptId="262" id="sputum_volume" answerConceptIds="264,265,266,267,268,269,3" defaultValue="269"/>
				</p>
			</div>
			<div id="specimen_time_div">
				<p>
					<lookup expression="fn.getConcept('112').description"/><br/>
					<obs conceptId="112" id="specimen_time" answerConceptIds="39,40,3" defaultValue="40"/>
				</p>
			</div>
			<div id="specimen_location_div">
				<p>
					<lookup expression="fn.getConcept('167').description"/><br/>
					<obs conceptId="167" id="specimen_location" answerConceptIds="160,163,164,165,166" defaultValue="160"/>
				</p>
				<div id="other_location_div">
					<p>
						<lookup expression="fn.getConcept('263').description"/><br/>
						<obs conceptId="263" id="other_location" size="20"/>
					</p>
				</div>
			</div>
			<p>
				<lookup expression="fn.getConcept('113').description"/><br/>
				<obs conceptId="113" id="barcode" size="13"/>
			</p>
		</div>
	</section>
	<submit/>

	<script type="text/javascript">
		if(jQuery) {
		$j(document).ready(function() {
			var isReferred = "<lookup complexExpression="$fn.latestObs(65).valueCoded"/>";
			var referralDiv = $j("#referral_div");
			if (isReferred == 1) {
				referralDiv.show();
			}
			else {
				referralDiv.hide();
			}
			// If referrer is other than "Family", then hide relationship
			$j("#referrer").change(function() {
				var relationshipDiv = $j("#relationship_div")
				var referrerValue = getValue('referrer.value');
				if (referrerValue == 85)
					relationshipDiv.show();
				else
					relationshipDiv.hide();
			});
			// If past medication history is "No", then hide current medication and streptomycin
			$j("#past_tb_medication").change(function() {
				var currentTbMedicationDiv = $j("#current_tb_medication_div");
				var streptomycinDiv = $j("#streptomycin_div");
				var pastTbMedicationValue = getValue('past_tb_medication.value');
				if (pastTbMedicationValue == 1) {
					currentTbMedicationDiv.show();
					streptomycinDiv.show();
				}
				else {
					currentTbMedicationDiv.hide();
					streptomycinDiv.hide();
				}					
			});
			$j("#past_tb_medication").change();
			// If the sputum type is "Sputum", then show sputum quality, volume, bloody sputum and time, otherwise show sputum location 
			$j("#specimen_type").change(function() {
				var sputumQualityDiv = $j("#sputum_quality_div");
				var sputumVolumeDiv = $j("#sputum_volume_div");
				var bloodySputumDiv = $j("#bloody_sputum_div");
				var specimenTimeDiv = $j("#specimen_time_div");
				var specimenLocationDiv = $j("#specimen_location_div");
				var sputumTypeValue = getValue('specimen_type.value');
				if (sputumTypeValue == 160) {
					sputumQualityDiv.show();
					sputumVolumeDiv.show();
					bloodySputumDiv.show();
					specimenTimeDiv.show();
					specimenLocationDiv.hide();
					setValue('specimen_location.value', 160);
				}
				else if (sputumTypeValue == 161) {
					sputumQualityDiv.hide();
					sputumVolumeDiv.hide();
					bloodySputumDiv.hide();
					specimenTimeDiv.hide();
					specimenLocationDiv.show();
					setValue('specimen_location.value', 163);
				}
			});
			$j("#specimen_type").change();
			// If specimen location is "Other..", then show other location text box
			$j("#specimen_location").change(function() {
				var otherLocationDiv = $j("#other_location_div")
				var specimenLocationValue = getValue('specimen_location.value');
				if (specimenLocationValue == 166)
					otherLocationDiv.show();
				else
					otherLocationDiv.hide();
			});
			//$j("#specimen_location").change();
		});
	}
	function luhnCheckDigit(number) {
		var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
		number = number.toUpperCase().trim();
		var sum = 0;
		for (var i = 0; i &lt; number.length; i++) 
		{
			var ch = number.charAt(number.length - i - 1);
			if (validChars.indexOf(ch) &lt; 0) {
				return -1;
			}
			var digit = ch.charCodeAt(0) - 48;
			var weight;
			if (i % 2 == 0) {
				weight = (2 * digit) - parseInt(digit / 5) * 9;
			}
			else {
				weight = digit;
			}
			sum += weight;
		}
		sum = Math.abs(sum) + 10;
		var digit = (10 - (sum % 10)) % 10;
		return digit;
	}
	<!-- Error Checking before Form Submit -->
	beforeSubmit.push(function() {
		// Validate barcode
		var valid = true;
		var error = '';
		var barcode = getValue('barcode.value');
		var pattern = new RegExp("^\\d{1,10}-\\d$");
		valid = pattern.test(barcode);
		if (!valid || barcode.length != 12) {
			error = "Lab test code is invalid or empty. Please check that you have entered correct lab test code.\n";
		}
		else {
			// Check Luhn digit for barcode
			var number = barcode.substring(0, barcode.length - 2);
			var digit = barcode.charAt(barcode.length - 1);
			var luhnDigit = luhnCheckDigit(number);
			if (digit != luhnDigit) {
				valid = false;
		    	error = "Lab test code is invalid or does not exist. Please check that you have entered correct lab test code.\n";			
			}
		}
		if (!valid) {
			alert (error);
		}
        return valid;
	});
	</script>
</htmlform>
