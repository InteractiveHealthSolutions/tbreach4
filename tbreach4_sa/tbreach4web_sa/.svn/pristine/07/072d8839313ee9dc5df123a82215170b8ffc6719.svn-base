<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Sputum Submission Form (v1.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date sputum handed from patient to screener:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser"/></td>
			</tr>
                         <tr>
				<td>Name:</td>
				<td><lookup class="value" expression="patient.personName"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Sputum Collection and Submission Form">
		
		<p>
			<lookup expression="fn.getConcept('53').description"/><br/>
			<obs conceptId="53" id="diabetes_treatment_initiated" defaultValue="32"/>
		</p>	
                <p>
			<lookup expression="fn.getConcept('58').description"/><br/>
			<obs conceptId="58" id="sputum_time" defaultValue="32"/>
		</p>	
                <p>
                         <b><span>Screener Instructions:</span></b>
                         <span id="screener_instruction_one"></span>
                </p>
                <p>
			<lookup expression="fn.getConcept('61').description"/><br/>
			<obs conceptId="61" id="s_accept_reject" defaultValue="59"/>
		</p>	
                 <div id="rejection_reason_div">
		<p>
			<lookup expression="fn.getConcept('66').description"/><br/>
			<obs conceptId="66" id="reject_reason" defaultValue="62"/>
		</p>	
                 <p>
                          <b><span id="screener_instruction_heading"></span></b>
                         <span id="screener_instruction_two"></span>
                 </p>
                </div>
                 <div id="lab_test_id_div">
	         <p>
			<lookup expression="fn.getConcept('67').description"/><br/>
			<obs conceptId="67" id="nhls_id"/>
		</p>
		</div>
	</section>

	<submit/>

       <script type="text/javascript">
		if(jQuery) {
                       $j("#s_accept_reject").change(function() {
                                
                                var rejectionReasonDiv = $j("#rejection_reason_div");
                                var labTestIdDiv = $j("#lab_test_id_div");
				var value = getValue('s_accept_reject.value');
				if (value == 60) {
					rejectionReasonDiv .show();
                                        labTestIdDiv.hide();
                                        document.getElementById("screener_instruction_heading").innerHTML="Screener Instructions:";
                                        document.getElementById("screener_instruction_two").innerHTML="Please take a new sputum sample from the Patient and fill this form again.";
				}
				else {
                                        if (value == 59) {
					    labTestIdDiv.show();
                                            rejectionReasonDiv .hide();
                                            document.getElementById("screener_instruction_heading").innerHTML="";
                                            document.getElementById("screener_instruction_two").innerHTML="";
                                        }
                                      labTestIdDiv.show();
                                      rejectionReasonDiv .hide();
                                      document.getElementById("screener_instruction_heading").innerHTML="";
                                      document.getElementById("screener_instruction_two").innerHTML="";
				}
			});
			$j("#s_accept_reject").change();
                       
                        $j("#sputum_time").change(function() {
 
				var value = getValue('sputum_time.value');
				if (value == 57) {
					document.getElementById("screener_instruction_one").innerHTML="This sample is too old. Reject this sample and ask the patient for another sputum sample. Repeat sputum instructions. "; 
				}
				else {
					document.getElementById("screener_instruction_one").innerHTML="Inspect Sputum Sample.";
				}
			});
			$j("#sputum_time").change();

                }

          <!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			// Validate lab test code
			var valid = true;
			var error = '';

                        var value = getValue('s_accept_reject.value');
                        if(value ==59){
                           var testId= getValue('nhls_id.value');
                           if (testId.length != 11) {
                                valid = false;
				error = "Lab Test Code is invalid or empty. Please check that you have entered correct lab test code.\n";
			   }
                           else{
                                var testIds = "<lookup complexExpression="#foreach($id in $fn.allObs(67)) $id.valueText #end"/>";
                                if(!testIds.indexOf(testId) > -1){
                                      valid = false;
				      error = error + "Lab test code is invalid or already exist. Please check that you have entered correct lab test code.\n";
                                  }
                           }
                        }

			if (!valid) {
				alert (error);
			}
	        return valid;
		});
	</script>
</htmlform>